# PROJ V3 - condição de corrida
## Considerando os problemas relativos ao acesso de recurso compartilhado discutidos em sala de aula, faça as seguintes alterações no Projeto Final:

### 1) Crie uma versão do código utilizando OpenMP;

### 2) Implemente a diretiva #pragma omp critical na variável global compartilhada por todas as threads comparando os valores e tempo de execução;

### 3) Crie um arquivo chamado critical.md de texto explicando como é feito o controle de acesso à região crítica para a variável global compartilhada do seu projeto;

### 4) Faça uma comparação de tempo de execução com 1, 2, ~~4 e 8~~ processadores para a versão paralela. Construa uma tabela contendo o tempo médio de 3 execuções para cada versão e sua respectiva quantidade de threads;

### 5) Faça um gráfico que mostre a escalabilidade do Speedup para cada quantidade de threads utilizada.

# 1 - Versão com OpenMP

Devido ao desenvolvimento na linguagem Java, não é possível a implementação de OpenMP. Versões equivalentes como JaMP foram evitadas por serem antigas e por apresentarem documentação insuficiente. De qualquer forma, Java permite uma paralelização e alcance de efeitos similares com seus recursos padrões.

# 2 - omp critical

O código já possui uma forma de controle de acesso. O loop em que a variável final é acessada se divide em iterações para cada thread. Esta variável final não é global, mas para cada instância, pois as threads trabalham dentro de uma classe Tarefa. Desta forma, o acesso à variável não causa interferências nas operações entre as threads, que permanecem em instância até o momento em que somam seus valores por meio de `.join`. Este controle está detalhado a mais no arquivo [critical.md](https://github.com/aug975/taylor/blob/main/V3/critical.md) no repositório.

Como não há variável global, um controle de uma região crítica não é necessário. Mas pode-se realizar uma comparação de tempo se modificarmos a variável `sum`, tornando ela global e passível de interferência.

```
class Tarefa extends Thread {

    private double x;
    private int precision;
    private int interval;
    private int steps;
    static BigDecimal sum = BigDecimal.ZERO;
```
> Tornamos sum _static_ em vez de private.

Esta modificação afeta o acesso e portanto o resultado da operação, que atualmente não possui possibilidade de interferência entre as threads e onde portanto essa região não é crítica, pois as threads podem operar nela ao mesmo tempo sem consequências ao resultado. Mas se transformamos em _static_, pode ocorrer interferência entre threads, pois agora `sum` é uma variável global e suas mudanças locais refletem no espaço de todas as threads. 
Com isso, surge uma região crítica do código. Se executamos este código, podemos comparar o valor total e o tempo com a versão original, onde há controle.

**Como o teste será realizado na AWS, utilizaremos a versão de 2 Threads, pois a AWS atualmente tem um limite de dois processadores. [Esta versão (não modificada) está no repositório.](https://github.com/aug975/taylor/blob/main/V3/main2Threads.java)**

![image](https://user-images.githubusercontent.com/101229028/201022657-e8bbfeef-c9c8-4487-b843-d05c9e9bac9f.png)

(...)

![image](https://user-images.githubusercontent.com/101229028/201022759-13c63480-1221-461b-abf0-18e3e62c6e39.png)
> Resultado sem controle[^1]

> Tempo: 5.719 s

Comparado com versão controlada:

![image](https://user-images.githubusercontent.com/101229028/200959799-3ac1e29c-ac17-4fcf-9d24-956029d46307.png)
> Resultado com controle[^2] 

> Tempo: 5.246 s

Percebe-se que sem o controle da região crítica, mesmo executando em quantidade similar de tempo, o valor total é incorreto devido à interferência entre as threads.

# 3 - [critical.md](https://github.com/aug975/taylor/blob/main/V3/critical.md)

# 4 - Comparação de tempo

Vamos comparar o tempo de execução com 1 processador (serial) e com 2 processadores. Para que a comparação seja justa, temos que comparar o tempo de execução do mesmo código. Para isto, usaremos a versão nThreads, que divide em tarefas equivalentes e proporcionais ao número de processadores disponíveis. [Esta versão está no repositório.](https://github.com/aug975/taylor/blob/main/V3/main_nThreads.java)

**Primeiro, testamos em uma máquina de 1 processador.**

![image](https://user-images.githubusercontent.com/101229028/200961574-9475225e-db01-47d2-8d79-51e5fd95f584.png)

Criamos o arquivo com `vim` e compilamos com `java`.

![image](https://user-images.githubusercontent.com/101229028/200961987-bac3cb51-a297-4bd8-872a-e3ac0c2946dc.png)

![image](https://user-images.githubusercontent.com/101229028/200961813-7319bfde-70c9-4828-8507-a253c09062af.png)

Executamos para 1 000 000 de termos com 10 000 de precisão.

![image](https://user-images.githubusercontent.com/101229028/200962151-5ebdebaf-8b80-4c5c-9e67-499ec7b5aded.png)

(...)

![image](https://user-images.githubusercontent.com/101229028/200962203-471f1a25-b4b5-4761-8dfe-8e97b7f6cbd3.png)

Temos um tempo de 9.175 segundos com 1 processador.

Realizamos mais 2 testes para obter o tempo médio para esta versão.

![image](https://user-images.githubusercontent.com/101229028/200962492-76461a79-88d0-47c1-a942-ecb3e9f765b5.png)
![image](https://user-images.githubusercontent.com/101229028/200962542-5bb41516-65a8-4f5b-a522-6aa2fcdc8d7d.png)

Temos um tempo médio de 8.368 segundos para esta versão.

**Agora, testamos em uma máquina com 2 processadores.**

![image](https://user-images.githubusercontent.com/101229028/200963744-2aeadb1b-58d7-426e-a02c-1d84ec9c242a.png)

Criamos o arquivo e compilamos. Novamente, temos 1 000 000 termos com 10 000 de precisão.

![image](https://user-images.githubusercontent.com/101229028/200963890-341601f9-5f41-4dba-9c8b-e1bcab604d7d.png)

(...)

![image](https://user-images.githubusercontent.com/101229028/200963924-20d11337-4487-4f75-ae9b-f4343305e9c6.png)

Temos um tempo de 6.445 segundos com 2 processadores.

Realizamos mais 2 testes.

![image](https://user-images.githubusercontent.com/101229028/200964017-500fef1b-63f0-41a3-aeeb-79bf42762849.png)
![image](https://user-images.githubusercontent.com/101229028/200964067-3c9ba00d-37c1-4993-8933-a00fa2673a2f.png)

Temos um tempo médio de 6.508 segundos para esta versão.

| Tempo médio | N.o threads |
|---|---|
| 8.368 | 1 |
| 6.508 | 2 |

# 5 - Speedup

![image](https://user-images.githubusercontent.com/101229028/200967321-cb59072e-dd9d-447c-8aa0-8475e8dc9539.png)

[^1]:<sub>Total: 5.4365636569180904707205749427053249955144941873999191499339352554481532607070951891427643570503328548525807193389340831530752284420920695709579937992470540766633080839857976882897483588669544927586774253097664491573512091656947984007772493777664149165092776606920980116949151881958833750009841062618765029384789580109953576047028959381364653868970251670739561567985428986677981525067607479920540485045449380098310843779216453197288924057501557025822818839041570493878455179653627415156489908318406705060927965100383592358351706942715720337479488707683991952031366692900376169727360054463116634320028365570913067625851022223150364007863754584667393212202619430821176634895135138966172800067902949883983169119183214790286927518885366379426411705156043969059370361146475969869625265063731576773204187460828401568101418925370323375157646594180514620000057612040830674283666841508503954994459193436318865038402064189151660034714070631014266599172448046369483079064276947672436809278550169617241943094327442749598136876802269044240098343256621887675110258904588194171860520839657930567030734820852196861207957380293529254236990224403524564477688763576519555387089274399353374432723220579044238143349085535022826710291524063798565217440237101012863541506813872851580108474318233489964131700920252171118536406665665998908575175198577852310683419444371956048368591137493227351995424141524234438041382237785236166962826284248979891501705372712703059431723258124252109732499899069558244784328302937981641636500963066454672534203607953560075680031577144658922183440523854418622945646309173399784700506432489696347635202375578122714397315140659879136394379509151285370321954773437457469229824819826247958303465096749617281144481899805262377738315126690523755557819503537527673894833596881378292575203299132384336333140652826830666424996812431086992529691097703473070988541978181323627749551890613871857568836811316024645399690896900309826175219074982861116702166451192471053887520260111614204583646963463232518661629290526550309755786080624591290891421320737534236625966908649447286193172536093600167375522225639629194632346297853510144924230830519195235888199058993409711317193626296705781441178379835151495834021320861589639381723285507805101998036316239108375163206681285806848566376675550510728604773321083790847579216693457702862977312609823358721838672293049540200117074256716450880723670917893170562391893263058928344864415421342685441653280499891702988158080396757871575497398686337076830800750369223046765782405856447706970863821926832234908543837151901363703897519545254963043146870043665173728366277399857885141177479936791300051403270199091455391826471698273252453273770056219857897551973875578740614326494852787449945318809785087838552789236755318203165910170801114053726760993359963656430508310304925876042141361456462678243531421668924954764464757041933544988640662889706747679155459538404337174561776417827431612621300643560231456076609105385790500090077090599599429524815118856748269905956623553868652276349368095617044074051191793864824619451073658350584546893487100433458347975043918326449985024954077831555269825782386995890556560638579457438839855123484844194470868986670053375442807475609618874600843264699036546991629032802549602115791439228731175898521420384682629219769322623670909290294814956118973943485589094715469465957776493829742027203860134291936240967557612107526925021561206265885485059641773173937828817331271222898241136943961862475172966716783744139314627620058617037216005892708504792432969647267716513865319540943426393913946545068543674796174258332051889506217029847018269930203770016387958762188829847061693470991019219646075171638032206887667523349854963249283752166393648406909241252298040990205399418585604980327894731091445973746094844059704026833793394823906280221084520995340286261353967177621625270754972837845336585491944190868798553262359981231389603495882668487180286340515367185618139251324062285695489248508637826684270125346643055438557751549035071701108024667394991242096249157260356095385030586050797049980962767341046440713950679175035835839847072816205696731766393710164833047262652583089548150267193505221909042020530019890377267890685643218426789297303577278121715507023219701805875410140031705190976806812226543934758356483482310102861916772813404695869309179805388816126422150609113491989888628811617837545517946197214031711404933538762542614332212269173491798170734846823142819706044836699085335599283237079999033658128065913531924989224408970271666681336729576000859689630946407483899926330109569932997491906997006987970750866745390669780732740343185755757774181444711070363686673995320897205181624812145429570886780127761976785748735424616544668977968033762603264726132697196065735373919361657232689237180115783953696666912302056567998175721038272295671404952385112237616319042496490678025248660900256078442463098277188764342402551080087995941369344141744257539046872107269360218800004122629464485213754527288821917478784388076205372747125334429011955002514314866329903586121774638684526713385126263681512084744174806419983473358498133889740514321847043498102350102232732375219962940262240031162876159152580832642143960703995448138459239895032340875137221219056335436431883857973940809868780045987576498351362262264348295885221357530946000053778349864454721242592831900804869771923242664264301383961260481239653227222395596527870565002354549153094141345578341111181421802665549133628237326113508076408840112799724743816698614993540246824359258094254857950428565466794504061580487173408798623115436679141325125116472285348446718632236281409343681223419650304215757401683989254105265455845133153121546565550271236531944486801940953744743935714509712321407453382558417596372345172144689851347457467181320546706789394795848375099005061347976871038744898758478987959093101736923007750504460026013677853617479601520243735013231094688264496882204252504949649660344143981109373146853373600570276348544741881089340969823537248495883962413993035885851311869728481973905346135405853610987856399268329738924289787667346291103841940116088044575268894433858877839090059944223011026897107739252531926312197650392627906642322026698636361559726005165438783868789459990222033780049662496547338327284916031701948846281430972701967983616942271980024825342179061658009012201400250351398096305835886533309759603298854604990532337505337127307473863302609578892882118329741725819260473457147623691426280133637107467308505627196425150253279660993973592078476274755830750924784297703392683395835460847540509924664066360237540874522245002013642374469259882220204996401507235039018959143287439108121370926144220484500259394205788182005894480671380026313951572444902107082490096657477637959805617656905015355233685865423840115740033933269442969837407227534920281158986921660149702437866504535763418309653228534402283514806136482288212577031098664625014297330121848232836457980719552422573809720662582522593991020929396602379973193574991406141975008948693702450652867614463977776564425528186195026419707873396736102051396140293710374637309399329683102369388409116526623252750775225382003662335533167295041740370219669427382846043393207992722758482758056942570295747707702798771778503979179621220177445120823217404486531178811173924859958873082928861709658357574142637920208338956241238810694409068255329767046063882942361574738580654315207364951155086521451193754589902104266407977310221682089964493600450899138817243997151963216818384220766089319241283701968806055563375248354627370610645630815630356684383189143038404089277711463079405650956023093865003335367659867937344926822378404366085873572452000492021752652641666221648034243863236422014365023586156788257815466013148933358111435951984179241074095051023097090122230113231162785843166536005036743657261875418053143301972405926880231327661343161521672349108843408078476247912756609472559540964417140051008389554849571252176830629695575012585820141343201601457817573119856764771617788245106591701492857382010353477585695735806395882919435805314237185643743855361037701693693761205449429334563964543558142480048482873720725165064488706474880636417411296342918611156107569584058179751583327939148089604334854473545335958974133892631432939591899091309465130605944679163882562678516652487681623636145898581160531434213814499275421537897329875697236988073343134729890773485011081111849315151547821616660040924908003400545168155736727627650809201328214258535948425604717666343154161724970362293097048409996938618187405719118903175676126592998932618501915705239406536918997304832393769410384558495731383139007774388807147215956373453258656062686180505015571553439869412093087520185130674658169235504380499804241327295786766521418347272134965821973543109969735161555968043616231793690288411239906768987675838673236809135656876537767095847237036827969537821410928557870070192351256890305975215769021896967176228744976463070859983602714901033407053529296919299851908720459413674017055354436841377310813113453765092668823895312962596863636411140228378295506730679051640424678312312150344047415492219048601527239409032454526820839576476232378835479812310734349207574961447976017462626354979489830016439842894115833121054156396767776756911978510068785536565587113299687041042033121939932432541555936950758108153804449714666576600387588543678095965284437038675038420963923446205799882854403545944598535763926477250335671958830920139306426794559183884322525147399538127721422023028184233602048044200439900424985377399341363474237100503829899227190526107106103136489229856098576622065918134794559250449994970254816797435854062249673554373845309223588486963590448490766953899339084691219152753869305132133555173573220200135947088533235202864475680375989894666360016327088455929834688251024562340146427036497731362647747755616426131726042698732008810372705109574040696950437675517778917300234973692485982455867914330411228489843858813491860912820019639493522183783080497825123857292681434007924508252181424738387625524591889825444229658045123</sub>

[^2]:<sub>2.7182818284590452353602874713526624977572470936999595749669676277240766303535475945713821785251664274274663919320030599218174135966290435729003342952605956307381323286279434907632338298807531952510190115738341879307021540891499348841675092447614606680822648001684774118537423454424371075390777449920695517027618386062613313845830007520449338265602976067371132007093287091274437470472306969772093101416928368190255151086574637721112523897844250569536967707854499699679468644549059879316368892300987931277361782154249992295763514822082698951936680331825288693984964651058209392398294887933203625094431173012381970684161403970198376793206832823764648042953118023287825098194558153017567173613320698112509961818815930416903515988885193458072738667385894228792284998920868058257492796104841984443634632449684875602336248270419786232090021609902353043699418491463140934317381436405462531520961836908887070167683964243781405927145635490613031072085103837505101157477041718986106873969655212671546889570350354021234078498193343210681701210056278802351930332247450158539047304199577770935036604169973297250886876966403555707162268447162560798826517871341951246652010305921236677194325278675398558944896970964097545918569563802363701621120477427228364896134225164450781824423529486363721417402388934412479635743702637552944483379980161254922785092577825620926226483262779333865664816277251640191059004916449982893150566047258027786318641551956532442586982946959308019152987211725563475463964479101459040905862984967912874068705048958586717479854667757573205681288459205413340539220001137863009455606881667400169842055804033637953764520304024322566135278369511778838638744396625322498506549958862342818997077332761717839280349465014345588970719425863987727547109629537415211151368350627526023264847287039207643100595841166120545297030236472549296669381151373227536450988890313602057248176585118063036442812314965507047510254465011727211555194866850800368532281831521960037356252794495158284188294787610852639813955990067376482922443752871846245780361929819713991475644882626039033814418232625150974827987779964373089970388867782271383605772978824125611907176639465070633045279546618550966661856647097113444740160704626215680717481877844371436988218559670959102596862002353718588748569652200050311734392073211390803293634479727355955277349071783793421637012050054513263835440001863239914907054797780566978533580489669062951194324730995876552368128590413832411607226029983305353708761389396391779574540161372236187893652605381558415871869255386061647798340254351284396129460352913325942794904337299085731580290958631382683291477116396337092400316894586360606458459251269946557248391865642097526850823075442545993769170419777800853627309417101634349076964237222943523661255725088147792231519747780605696725380171807763603462459278778465850656050780844211529697521890874019660906651803516501792504619501366585436632712549639908549144200014574760819302212066024330096412704894390397177195180699086998606636583232278709376502260149291011517177635944602023249300280401867723910288097866605651183260043688508817157238669842242201024950551881694803221002515426494639812873677658927688163598312477886520141174110913601164995076629077943646005851941998560162647907615321038727557126992518275687989302761761146162549356495903798045838182323368612016243736569846703785853305275833337939907521660692380533698879565137285593883499894707416181550125397064648171946708348197214488898790676503795903669672494992545279033729636162658976039498576741397359441023744329709355477982629614591442936451428617158587339746791897571211956187385783644758448423555581050025611492391518893099463428413936080383091662818811503715284967059741625628236092168075150177725387402564253470879089137291722828611515915683725241630772254406337875931059826760944203261924285317018781772960235413060672136046000389661093647095141417185777014180606443636815464440053316087783143174440811949422975599314011888683314832802706553833004693290115744147563139997221703804617092894579096271662260740718749975359212756084414737823303270330168237193648002173285734935947564334129943024850235732214597843282641421684878721673367010615094243456984401873312810107945127223737886126058165668053714396127888732527373890392890506865324138062796025930387727697783792868409325365880733988457218746021005311483351323850047827169376218004904795597959290591655470505777514308175112698985188408718564026035305583737832422924185625644255022672155980274012617971928047139600689163828665277009752767069777036439260224372841840883251848770472638440379530166905465937461619323840363893131364327137688841026811219891275223056256756254701725086349765367288605966752740868627407912856576996313789753034660616669804218267724560530660773899624218340859882071864682623215080288286359746839654358856685503773131296587975810501214916207656769950659715344763470320853215603674828608378656803073062657633469774295634643716709397193060876963495328846833613038829431040800296873869117066666146800015121143442256023874474325250769387077775193299942137277211258843608715834835626961661980572526612206797540621062080649882918454395301529982092503005498257043390553570168653120526495614857249257386206917403695213533732531666345466588597286659451136441370331393672118569553952108458407244323835586063106806964924851232632699514603596037297253198368423363904632136710116192821711150282801604488058802382031981493096369596735832742024988245684941273860566491352526706046234450549227581151709314921879592718001940968866986837037302200475314338181092708030017205935530520700706072233999463990571311587099635777359027196285061146514837526209565346713290025994397663114545902685898979115837093419370441155121920117164880566945938131183843765620627846310490346293950029458341164824114969758326011800731699437393506966295712410273239138741754923071862454543222039552735295240245903805744502892246886285336542213815722131163288112052146489805180092024719391710555390113943316681515828843687606961102505171007392762385553386272553538830960671644662370922646809671254061869502143176211668140097595281493907222601112681153108387317617323235263605838173151034595736538223534992935822836851007810884634349983518404451704270189381994243410090575376257767571118090088164183319201962623416288166521374717325477727783488774366518828752156685719506371936565390389449366421764003121527870222366463635755503565576948886549500270853923617105502131147413744106134445544192101336172996285694899193369184729478580729156088510396781959429833186480756083679551496636448965592948187851784038773326247051945050419847742014183947731202815886845707290544057510601285258056594703046836344592652552137008068752009593453607316226118728173928074623094685367823106097921599360019946237993434210687813497346959246469752506246958616909178573976595199392993995567542714654910456860702099012606818704984178079173924071945996323060254707901774527513186809982284730860766536866855516467702911336827563107223346726113705490795365834538637196235856312618387156774118738527722922594743373785695538456246801013905727871016512966636764451872465653730402443684140814488732957847348490003019477888020460324660842875351848364959195082888323206522128104190448047247949291342284951970022601310430062410717971502793433263407995960531446053230488528972917659876016667811937932372453857209607582277178483361613582612896226118129455927462767137794487586753657544861407611931125958512655759734573015333642630767985443385761715333462325270572005303988289499034259566232975782488735029259166825894456894655992658454762694528780516501720674785417887982276806536650641910973434528878338621726156269582654478205672987756426325321594294418039943217000090542650763095588465895171709147607437136893319469090981904501290307099566226620303182649365733698419555776963787624918852865686607600566025605445711337286840205574416030837052312242587223438854123179481388550075689381124935386318635287083799845692619981794523364087429591180747453419551420351726184200845509170845682368200897739455842679214273477560879644279202708312150156406341341617166448069815483764491573900121217041547872591998943825364950514771379399147205219529079396137621107238494290616357604596231253506068537651423115349665683715116604220796394466621163255157729070978473156278277598788136491951257483328793771571459091064841642678309949723674420175862269402159407924480541255360431317992696739157542419296607312393763542139230617876753958711436104089409966089471418340698362993675362621545247298464213752891079884381306095552622720837518629837066787224430195793793786072107254277289071732854874374355781966511716618330881129120245204048682200072344035025448202834254187884653602591506445271657700044521097735585897622655484941621714989532383421600114062950718490427789258552743035221396835679018076406042138307308774460170842688272261177180842664333651780002171903449234264266292261456004337383868335555343453004264818473989215627086095650629340405264943244261445665921291225648893569655009154306426134252668472594914314239398845432486327461842846655985332312210466259890141712103446084271616619001257195870793217569698544013397622096749454185407118446433946990162698351607848924514058940946395267807354579700307051163682519487701189764002827648414160587206184185297189154019688253289309149665345753571427318482016384644832499037886069008072709327673127581966563941148961716832980455139729506687604740915420428429993541025829113502241690769431668574242522509026939034814856451303069925199590436384028429267412573422447765584177886171737265462085498294498946787350929581652632072258992368768457017823038096567883112289305809140572610865884845873101658151167533327674887014829167419701512559782572707406431808601428149024146780472327597684269633935773542930186739439716388611764209004068663398856841681003872389214483176070116684503887212364367043314091155733280182977988736590916659612402021778558854876176161989370794380056663364884365089144805571039765214696027662583599051987042300179465536833</sub>
